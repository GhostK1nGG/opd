{% extends "base.html" %}
{% set active = "bookings" %}
{% set page_title = "Брони" %}
{% set page_subtitle = "Управление бронированиями, услугами, посещениями и оплатами" %}
{% set fab_url = url_for('booking_create') %}
{% set fab_title = "Новая бронь" %}
{% block content %}

<div class="card">
  <div class="card-header" style="margin-bottom: 10px;">
    <div class="card-title">
      <h3>Список бронирований</h3>
      <p>Показаны последние 200 записей</p>
    </div>
    <div class="actions">
      <a class="icon-btn" href="{{ url_for('booking_create') }}" title="Новая бронь"><i class="fa-solid fa-plus"></i></a>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Клиент</th>
          <th>Зона</th>
          <th>Тренер</th>
          <th>Тип</th>
          <th>Период</th>
          <th style="text-align:right;">Итого</th>
          <th style="text-align:right;">Оплачено</th>
          <th style="text-align:right;">Остаток</th>
          <th>Статус</th>
          <th style="text-align:right;"></th>
        </tr>
      </thead>
      <tbody>
        {% for b in bookings %}
          {% set paid = paid_map.get(b.id, 0.0) %}
          {% set total = (b.total_sum or 0) %}
          <tr>
            <td>#{{ b.id }}</td>
            <td>{{ b.client.full_name }}</td>
            <td>{{ b.zone.zone_name }}</td>
            <td>{{ b.schedule_slot.employee.full_name if b.schedule_slot and b.schedule_slot.employee else "—" }}</td>
            <td>
              {% if b.schedule_slot %}
                {{ "Групповое" if b.schedule_slot.lesson_type == "group" else "Индивидуальное" }}
              {% else %}
                —
              {% endif %}
            </td>
            <td style="color: var(--text-secondary); font-size: 13px;">
              {{ b.datetime_from.strftime("%d.%m.%Y %H:%M") }} — {{ b.datetime_to.strftime("%H:%M") }}
            </td>
            <td style="text-align:right;">{{ "%.2f"|format(total) }}</td>
            <td style="text-align:right;">{{ "%.2f"|format(paid) }}</td>
            <td style="text-align:right;">{{ "%.2f"|format((total|float) - (paid|float)) }}</td>
            <td><span class="badge"><i class="fa-regular fa-circle"></i> {{ b.status.name }}</span></td>
            <td style="text-align:right;">
              <a class="icon-btn" href="{{ url_for('booking_view', booking_id=b.id) }}" title="Открыть"><i class="fa-solid fa-arrow-right"></i></a>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="11" style="color: var(--text-secondary); padding: 18px;">Нет бронирований</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
